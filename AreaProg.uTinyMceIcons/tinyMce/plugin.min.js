tinymce.PluginManager.add('uTinyMceIcons', function (editor, url) {
    var tpl = '<div ng-controller="uTinyMceIconsOverlayController"><umb-overlay ng-if="overlay.show" model="overlay" view="overlay.view" position="right"></umb-overlay></div>';
    var controller = {};
    
    editor.on('init', function () {
        // Retrieve the main div of the property editor
        var element = editor.iframeElement;

        while (element && element.getAttribute("ng-controller") !== "Umbraco.PropertyEditors.RTEController" && element.getAttribute("ng-controller") !== "Umbraco.PropertyEditors.GridController") {
            element = element.parentElement;
        }

        // Inject uTinyMceIconsOverlayController
        var template = angular.element(tpl);
        var $injector = angular.element('html').injector();
        var $compile = $injector.get('$compile');
        var $rootScope = $injector.get('$rootScope');

        $rootScope.$apply(function () {
            var content = $compile(template)($rootScope.$new());
            angular.element(element).append(content);
            controller = content.scope();
        });

        var editorHeadTag = editor.iframeElement.contentDocument.getElementsByTagName('head')[0];

        // Inject some CSS to change the icon appareance when selected in tinymce
        var styleElement = editor.dom.create('style');

        styleElement.innerText = 'span.fa[data-mce-selected="1"]{color: #fff;background: #413659;}';
        editorHeadTag.appendChild(styleElement);

        // Inject font awesome CSS to display the icon in tinymce
        editorHeadTag.appendChild(editor.dom.create('link', {
            rel: 'stylesheet',
            href: url.substring(0, url.indexOf('/lib/') + 5) + 'font-awesome/css/font-awesome.min.css'
        }));
    });

    editor.addButton('uTinyMceIcons', {
        icon: 'uTinyMceIcons',
        tooltip: 'Icon',
        onclick: function () {
            controller.showPane(editor);
        }
    });
});